<div class="moderation-settings">
  <header class="page-header">
    <div class="header-content">
      <h1>Modération IA</h1>
      <p class="description">
        Définissez des règles de modération en langage naturel et configurez les guardrails NVIDIA NeMo
        pour la sécurité de vos agents IA.
      </p>
    </div>
    <div class="header-actions">
      <app-custom-button
        [disabled]="isLoading"
        (click)="resetToDefaults()"
        variant="danger"
        label="Réinitialiser"
      ></app-custom-button>
      <app-custom-button
        [disabled]="isSaving || !settings"
        (click)="saveSettings()"
        variant="primary"
        [label]="isSaving ? 'Sauvegarde...' : 'Sauvegarder'"
      ></app-custom-button>
    </div>
  </header>

  <!-- Messages -->
  <div *ngIf="errorMessage" class="message error">{{ errorMessage }}</div>
  <div *ngIf="successMessage" class="message success">{{ successMessage }}</div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading">Chargement des paramètres...</div>

  <!-- Content -->
  <div *ngIf="settings && !isLoading" class="settings-content">
    <!-- Tabs -->
    <nav class="tabs">
      <button [class.active]="activeTab === 'global'" (click)="setActiveTab('global')">
        Règles globales
      </button>
      <button [class.active]="activeTab === 'agents'" (click)="setActiveTab('agents')">
        Par agent
      </button>
      <button [class.active]="activeTab === 'users'" (click)="setActiveTab('users')">
        Par utilisateur
      </button>
      <button [class.active]="activeTab === 'test'" (click)="setActiveTab('test')">
        Tester
      </button>
      <span class="tab-separator"></span>
      <button class="tab-nvidia" [class.active]="activeTab === 'guardrails'" (click)="setActiveTab('guardrails')">
        NeMo Guardrails
      </button>
      <button class="tab-nvidia" [class.active]="activeTab === 'gr-topics'" (click)="setActiveTab('gr-topics')">
        Topics
      </button>
      <button class="tab-nvidia" [class.active]="activeTab === 'gr-content'" (click)="setActiveTab('gr-content')">
        Contenu
      </button>
      <button class="tab-nvidia" [class.active]="activeTab === 'gr-jailbreak'" (click)="setActiveTab('gr-jailbreak')">
        Jailbreak
      </button>
      <button class="tab-nvidia" [class.active]="activeTab === 'gr-models'" (click)="setActiveTab('gr-models')">
        Modèles
      </button>
      <button class="tab-nvidia" [class.active]="activeTab === 'gr-test'" (click)="setActiveTab('gr-test')">
        Tester GR
      </button>
    </nav>

    <div class="tab-content">
      <!-- ===== GLOBAL RULES ===== -->
      <div *ngIf="activeTab === 'global'" class="panel">
        <h2>Règles globales de modération</h2>
        <p class="panel-description">
          Ces règles s'appliquent à tous les agents et tous les utilisateurs.
          Exprimez vos consignes en langage naturel, l'IA s'occupe du reste.
        </p>

        <div class="form-group">
          <label class="toggle-label">
            <input type="checkbox" [(ngModel)]="settings.global_config.enabled" />
            <span class="toggle-text">Activer la modération globale</span>
          </label>
        </div>

        <!-- Existing rules -->
        <div class="rules-list">
          <div *ngFor="let rule of settings.global_config.rules; let i = index" class="rule-item" [class.disabled]="!rule.enabled">
            <div class="rule-content">
              <button class="toggle-btn" [class.active]="rule.enabled" (click)="toggleGlobalRule(i)" [title]="rule.enabled ? 'Désactiver' : 'Activer'">
                {{ rule.enabled ? '&#9679;' : '&#9675;' }}
              </button>
              <span class="rule-text">{{ rule.instruction }}</span>
            </div>
            <button class="remove-btn" (click)="removeGlobalRule(i)" title="Supprimer">&times;</button>
          </div>
        </div>

        <!-- Add new rule -->
        <div class="add-rule">
          <textarea
            [(ngModel)]="newGlobalRule"
            placeholder="Décrivez une règle de modération en langage naturel. Ex: 'Bloquer les demandes liées à des sujets personnels non professionnels'"
            rows="3"
            (keydown.ctrl.enter)="addGlobalRule()"
          ></textarea>
          <app-custom-button
            [disabled]="!newGlobalRule.trim()"
            (click)="addGlobalRule()"
            variant="primary"
            label="Ajouter la règle"
          ></app-custom-button>
        </div>
      </div>

      <!-- ===== PER AGENT ===== -->
      <div *ngIf="activeTab === 'agents'" class="panel">
        <h2>Modération par agent</h2>
        <p class="panel-description">
          Définissez des règles spécifiques pour chaque agent, en plus des règles globales.
        </p>

        <!-- Add agent -->
        <div class="add-config">
          <select [(ngModel)]="selectedAgentId">
            <option value="">-- Sélectionner un agent --</option>
            <option *ngFor="let agent of getAvailableAgents()" [value]="agent.id">
              {{ agent.name }}
            </option>
          </select>
          <app-custom-button
            [disabled]="!selectedAgentId"
            (click)="addAgentConfig()"
            variant="primary"
            label="Ajouter"
          ></app-custom-button>
        </div>

        <div *ngIf="settings.agent_configs.length === 0" class="empty-state">
          Aucune règle spécifique par agent. Les règles globales s'appliquent à tous les agents.
        </div>

        <!-- Agent configs -->
        <div *ngFor="let agentConfig of settings.agent_configs; let ai = index" class="config-card">
          <div class="config-header">
            <div class="config-title">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="agentConfig.enabled" />
                <span class="toggle-text">{{ agentConfig.agent_name || agentConfig.agent_id }}</span>
              </label>
            </div>
            <button class="remove-btn" (click)="removeAgentConfig(ai)" title="Supprimer la config agent">&times;</button>
          </div>

          <div class="rules-list">
            <div *ngFor="let rule of agentConfig.rules; let ri = index" class="rule-item" [class.disabled]="!rule.enabled">
              <div class="rule-content">
                <button class="toggle-btn" [class.active]="rule.enabled" (click)="toggleAgentRule(agentConfig.agent_id, ri)">
                  {{ rule.enabled ? '&#9679;' : '&#9675;' }}
                </button>
                <span class="rule-text">{{ rule.instruction }}</span>
              </div>
              <button class="remove-btn" (click)="removeAgentRule(agentConfig.agent_id, ri)">&times;</button>
            </div>
          </div>

          <div class="add-rule compact">
            <textarea
              [(ngModel)]="newAgentRule[agentConfig.agent_id]"
              placeholder="Nouvelle règle pour cet agent..."
              rows="2"
              (keydown.ctrl.enter)="addAgentRule(agentConfig.agent_id)"
            ></textarea>
            <app-custom-button
              [disabled]="!newAgentRule[agentConfig.agent_id]?.trim()"
              (click)="addAgentRule(agentConfig.agent_id)"
              variant="secondary"
              label="Ajouter"
            ></app-custom-button>
          </div>
        </div>
      </div>

      <!-- ===== PER USER ===== -->
      <div *ngIf="activeTab === 'users'" class="panel">
        <h2>Modération par utilisateur</h2>
        <p class="panel-description">
          Définissez des règles spécifiques pour certains utilisateurs, en plus des règles globales.
        </p>

        <!-- Add user -->
        <div class="add-config">
          <select [(ngModel)]="selectedUserId">
            <option value="">-- Sélectionner un utilisateur --</option>
            <option *ngFor="let user of getAvailableUsers()" [value]="user.id">
              {{ user.username }} {{ user.email ? '(' + user.email + ')' : '' }}
            </option>
          </select>
          <app-custom-button
            [disabled]="!selectedUserId"
            (click)="addUserConfig()"
            variant="primary"
            label="Ajouter"
          ></app-custom-button>
        </div>

        <div *ngIf="settings.user_configs.length === 0" class="empty-state">
          Aucune règle spécifique par utilisateur. Les règles globales s'appliquent à tous.
        </div>

        <!-- User configs -->
        <div *ngFor="let userConfig of settings.user_configs; let ui = index" class="config-card">
          <div class="config-header">
            <div class="config-title">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="userConfig.enabled" />
                <span class="toggle-text">{{ userConfig.username || userConfig.user_id }}</span>
              </label>
            </div>
            <button class="remove-btn" (click)="removeUserConfig(ui)" title="Supprimer la config utilisateur">&times;</button>
          </div>

          <div class="rules-list">
            <div *ngFor="let rule of userConfig.rules; let ri = index" class="rule-item" [class.disabled]="!rule.enabled">
              <div class="rule-content">
                <button class="toggle-btn" [class.active]="rule.enabled" (click)="toggleUserRule(userConfig.user_id, ri)">
                  {{ rule.enabled ? '&#9679;' : '&#9675;' }}
                </button>
                <span class="rule-text">{{ rule.instruction }}</span>
              </div>
              <button class="remove-btn" (click)="removeUserRule(userConfig.user_id, ri)">&times;</button>
            </div>
          </div>

          <div class="add-rule compact">
            <textarea
              [(ngModel)]="newUserRule[userConfig.user_id]"
              placeholder="Nouvelle règle pour cet utilisateur..."
              rows="2"
              (keydown.ctrl.enter)="addUserRule(userConfig.user_id)"
            ></textarea>
            <app-custom-button
              [disabled]="!newUserRule[userConfig.user_id]?.trim()"
              (click)="addUserRule(userConfig.user_id)"
              variant="secondary"
              label="Ajouter"
            ></app-custom-button>
          </div>
        </div>
      </div>

      <!-- ===== TEST ===== -->
      <div *ngIf="activeTab === 'test'" class="panel">
        <h2>Tester la modération</h2>
        <p class="panel-description">
          Testez vos règles en simulant un message utilisateur. L'IA évaluera le message selon les règles configurées.
        </p>

        <div class="test-context">
          <div class="form-group">
            <label>Agent (optionnel)</label>
            <select [(ngModel)]="testAgentId">
              <option value="">-- Tous les agents --</option>
              <option *ngFor="let config of settings.agent_configs" [value]="config.agent_id">
                {{ config.agent_name || config.agent_id }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Utilisateur (optionnel)</label>
            <select [(ngModel)]="testUserId">
              <option value="">-- Tous les utilisateurs --</option>
              <option *ngFor="let config of settings.user_configs" [value]="config.user_id">
                {{ config.username || config.user_id }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="testContent">Message à tester</label>
          <textarea
            id="testContent"
            [(ngModel)]="testContent"
            rows="4"
            placeholder="Entrez un message à tester contre les règles de modération..."
          ></textarea>
        </div>

        <app-custom-button
          [disabled]="isTesting || !testContent.trim()"
          (click)="testModeration()"
          variant="primary"
          [label]="isTesting ? 'Analyse en cours...' : 'Tester la modération'"
        ></app-custom-button>

        <div *ngIf="testResult" class="test-result" [class.blocked]="!testResult.approved">
          <div class="result-header">
            <span class="result-status" [class.blocked]="!testResult.approved">
              {{ testResult.approved ? 'APPROUVE' : 'BLOQUE' }}
            </span>
          </div>

          <div class="result-details">
            <div class="detail-item">
              <strong>Décision :</strong>
              <span>{{ testResult.reason }}</span>
            </div>

            <div *ngIf="testResult.matched_rules.length > 0" class="detail-item">
              <strong>Règles enfreintes :</strong>
              <ul>
                <li *ngFor="let rule of testResult.matched_rules">{{ rule }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: GENERAL ===== -->
      <div *ngIf="activeTab === 'guardrails'" class="panel">
        <div class="gr-header">
          <h2>NeMo Guardrails - Configuration générale</h2>
          <div class="gr-actions">
            <app-custom-button
              (click)="resetGrToDefaults()"
              variant="danger"
              label="Réinitialiser GR"
            ></app-custom-button>
            <app-custom-button
              [disabled]="grIsSaving || !grSettings"
              (click)="saveGrSettings()"
              variant="primary"
              [label]="grIsSaving ? 'Sauvegarde...' : 'Sauvegarder GR'"
            ></app-custom-button>
          </div>
        </div>
        <p class="panel-description">
          Activez ou désactivez les différents types de vérification NeMo Guardrails NVIDIA.
        </p>

        <div *ngIf="grSettings">
          <div class="form-group">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="grSettings.enabled" />
              <span class="toggle-text"><strong>Activer NeMo Guardrails</strong></span>
            </label>
            <p class="hint">Active le système de guardrails NVIDIA pour tous les agents.</p>
          </div>

          <div class="guardrails-toggles" [class.disabled]="!grSettings.enabled">
            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="grSettings.config.topic_check_enabled" [disabled]="!grSettings.enabled" />
                <span class="toggle-text">Vérification de topic</span>
              </label>
              <p class="hint">Vérifie que le sujet du message est dans les topics autorisés.</p>
            </div>

            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="grSettings.config.content_check_enabled" [disabled]="!grSettings.enabled" />
                <span class="toggle-text">Modération de contenu</span>
              </label>
              <p class="hint">Détecte le contenu inapproprié (violence, haine, etc.).</p>
            </div>

            <div class="form-group">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="grSettings.config.jailbreak_check_enabled" [disabled]="!grSettings.enabled" />
                <span class="toggle-text">Détection de jailbreak</span>
              </label>
              <p class="hint">Détecte les tentatives de contournement des règles de sécurité.</p>
            </div>
          </div>
        </div>
        <div *ngIf="!grSettings" class="empty-state">
          Impossible de charger la configuration NeMo Guardrails.
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: TOPICS ===== -->
      <div *ngIf="activeTab === 'gr-topics' && grSettings" class="panel">
        <h2>Filtrage par topic</h2>
        <p class="panel-description">
          Définissez les sujets autorisés et bloqués. Le modèle NeMoGuard classifie chaque message.
        </p>

        <div class="two-columns">
          <!-- Allowed Topics -->
          <div class="column">
            <h3 class="column-title allowed">Topics autorisés</h3>
            <div class="tags-list">
              <span *ngFor="let topic of grSettings.config.allowed_topics; let i = index" class="tag allowed">
                {{ topic }}
                <button class="tag-remove" (click)="removeAllowedTopic(i)">&times;</button>
              </span>
            </div>
            <div class="add-tag">
              <input
                [(ngModel)]="newAllowedTopic"
                placeholder="Nouveau topic autorisé..."
                (keydown.enter)="addAllowedTopic()"
              />
              <app-custom-button
                [disabled]="!newAllowedTopic.trim()"
                (click)="addAllowedTopic()"
                variant="primary"
                label="+"
              ></app-custom-button>
            </div>
          </div>

          <!-- Blocked Topics -->
          <div class="column">
            <h3 class="column-title blocked">Topics bloqués</h3>
            <div class="tags-list">
              <span *ngFor="let topic of grSettings.config.blocked_topics; let i = index" class="tag blocked">
                {{ topic }}
                <button class="tag-remove" (click)="removeBlockedTopic(i)">&times;</button>
              </span>
            </div>
            <div class="add-tag">
              <input
                [(ngModel)]="newBlockedTopic"
                placeholder="Nouveau topic bloqué..."
                (keydown.enter)="addBlockedTopic()"
              />
              <app-custom-button
                [disabled]="!newBlockedTopic.trim()"
                (click)="addBlockedTopic()"
                variant="danger"
                label="+"
              ></app-custom-button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: CONTENT ===== -->
      <div *ngIf="activeTab === 'gr-content' && grSettings" class="panel">
        <h2>Règles de modération de contenu</h2>
        <p class="panel-description">
          Configurez les catégories de contenu à bloquer et les seuils de détection.
        </p>

        <div class="content-rules">
          <div *ngFor="let rule of grSettings.config.content_rules; let i = index" class="content-rule-item">
            <div class="rule-info">
              <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="rule.blocked" />
                <span class="toggle-text category-name">{{ rule.category }}</span>
              </label>
            </div>
            <div class="rule-threshold">
              <label>Seuil: {{ formatThreshold(rule.threshold) }}</label>
              <input
                type="range"
                min="0" max="1" step="0.05"
                [(ngModel)]="rule.threshold"
              />
            </div>
            <button class="remove-btn" (click)="removeContentRule(i)" title="Supprimer">&times;</button>
          </div>
        </div>

        <div *ngIf="grSettings.config.content_rules.length === 0" class="empty-state">
          Aucune règle de contenu configurée.
        </div>

        <!-- Add content rule -->
        <div class="add-rule-inline">
          <select [(ngModel)]="newContentCategory">
            <option value="">-- Ajouter une catégorie --</option>
            <option *ngFor="let cat of getAvailableCategories()" [value]="cat">{{ cat }}</option>
          </select>
          <app-custom-button
            [disabled]="!newContentCategory"
            (click)="addContentRule()"
            variant="primary"
            label="Ajouter"
          ></app-custom-button>
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: JAILBREAK ===== -->
      <div *ngIf="activeTab === 'gr-jailbreak' && grSettings" class="panel">
        <h2>Détection de jailbreak</h2>
        <p class="panel-description">
          Configurez la sensibilité de la détection des tentatives de jailbreak et d'injection de prompt.
        </p>

        <div class="form-group">
          <label class="form-label">
            Seuil de détection: {{ formatThreshold(grSettings.config.jailbreak_threshold) }}
          </label>
          <input
            type="range"
            min="0" max="1" step="0.05"
            [(ngModel)]="grSettings.config.jailbreak_threshold"
            class="full-width-slider"
          />
          <p class="hint">
            Un seuil plus bas détectera plus de tentatives (plus de faux positifs).
            Un seuil plus haut ne détectera que les tentatives les plus évidentes.
          </p>
        </div>

        <div class="jailbreak-info">
          <h3>Techniques détectées</h3>
          <ul>
            <li><strong>Injection de prompt</strong> - Tentatives d'ajouter des instructions cachées</li>
            <li><strong>Role-playing</strong> - Jeux de rôle pour contourner les restrictions</li>
            <li><strong>Encodage</strong> - Utilisation de base64, ROT13, etc. pour cacher du contenu</li>
            <li><strong>Ingénierie sociale</strong> - Tentatives d'extraction du system prompt</li>
            <li><strong>Attaques DAN</strong> - "Do Anything Now" et variantes</li>
          </ul>
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: MODELS ===== -->
      <div *ngIf="activeTab === 'gr-models' && grSettings" class="panel">
        <h2>Modèles NVIDIA Safety</h2>
        <p class="panel-description">
          Sélectionnez les modèles NVIDIA à utiliser pour chaque type de vérification.
        </p>

        <div class="model-config">
          <div class="form-group">
            <label class="form-label">Modèle de classification de topic</label>
            <select [(ngModel)]="grSettings.config.topic_model" class="full-width">
              <option [ngValue]="null">Par défaut (nvidia/llama-3.1-nemoguard-8b-topic-control)</option>
              <option *ngFor="let model of getSafetyModels('topic')" [value]="model.id">
                {{ model.label }} ({{ model.id }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Modèle de modération de contenu</label>
            <select [(ngModel)]="grSettings.config.content_model" class="full-width">
              <option [ngValue]="null">Par défaut (nvidia/llama-3.1-nemoguard-8b-content-safety)</option>
              <option *ngFor="let model of getSafetyModels('content')" [value]="model.id">
                {{ model.label }} ({{ model.id }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Modèle de détection de jailbreak</label>
            <select [(ngModel)]="grSettings.config.jailbreak_model" class="full-width">
              <option [ngValue]="null">Par défaut (nvidia/llama-3.1-nemoguard-8b-content-safety)</option>
              <option *ngFor="let model of getSafetyModels('jailbreak')" [value]="model.id">
                {{ model.label }} ({{ model.id }})
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- ===== NEMO GUARDRAILS: TEST ===== -->
      <div *ngIf="activeTab === 'gr-test'" class="panel">
        <h2>Tester les guardrails</h2>
        <p class="panel-description">
          Testez vos règles NeMo Guardrails en simulant un message utilisateur.
        </p>

        <div class="form-group">
          <label for="grTestContent">Message à tester</label>
          <textarea
            id="grTestContent"
            [(ngModel)]="grTestContent"
            rows="4"
            placeholder="Entrez un message à tester contre les guardrails NeMo..."
          ></textarea>
        </div>

        <app-custom-button
          [disabled]="grIsTesting || !grTestContent.trim()"
          (click)="testGuardrails()"
          variant="primary"
          [label]="grIsTesting ? 'Analyse en cours...' : 'Tester les guardrails'"
        ></app-custom-button>

        <div *ngIf="grTestResult" class="test-result" [class.blocked]="!grTestResult.approved">
          <div class="result-header">
            <span class="result-status" [class.blocked]="!grTestResult.approved">
              {{ grTestResult.approved ? 'APPROUVE' : 'BLOQUE' }}
            </span>
            <span class="risk-score">
              Score de risque: {{ (grTestResult.risk_score * 100).toFixed(0) }}%
            </span>
            <span *ngIf="grTestResult.processing_time_ms" class="processing-time">
              ({{ grTestResult.processing_time_ms.toFixed(0) }}ms)
            </span>
          </div>

          <div *ngIf="grTestResult.blocked_reason" class="result-reason">
            <strong>Raison:</strong> {{ grTestResult.blocked_reason }}
          </div>

          <div class="result-checks">
            <h4>Vérifications effectuées:</h4>
            <div *ngFor="let check of grTestResult.checks" class="check-item" [class.failed]="!check.passed">
              <span class="check-icon">{{ check.passed ? '&#10003;' : '&#10007;' }}</span>
              <span class="check-type">{{ check.check_type }}</span>
              <span *ngIf="check.score !== null" class="check-score">
                ({{ (check.score * 100).toFixed(0) }}%)
              </span>
              <span class="check-details">{{ check.details }}</span>
              <span *ngIf="check.matched_category" class="check-category">
                [{{ check.matched_category }}]
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
